<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Centrum Dyspozytorskie</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
    }
    #container {
        display: flex;
        height: 100%;
    }
    #map {
        flex: 7;
        height: 100%;
    }
    #sidebar {
        flex: 3;
        padding: 10px;
        overflow-y: auto;
        background: #f4f4f4;
        border-left: 1px solid #ccc;
    }
    .report-item, .unit-item {
        background: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
    }
    .report-item:hover, .unit-item:hover {
        background: #e9e9e9;
    }
    .tier-1 { border-left: 5px solid green; }
    .tier-2 { border-left: 5px solid orange; }
    .tier-3 { border-left: 5px solid red; }
    .available { border-left: 5px solid green; }
    .unavailable { border-left: 5px solid red; }
    .on-intervention { border-left: 5px solid orange; }
    .delete-btn {
        float: right;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .assign-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-top: 5px;
    }
    .unit-status-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 3px 6px;
        border-radius: 3px;
        cursor: pointer;
        margin-right: 5px;
        margin-top: 5px;
        font-size: 0.8em;
    }
    .form-group {
        margin-bottom: 10px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    input, select, textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    button {
        padding: 8px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    button:hover {
        background: #0056b3;
    }
</style>
</head>
<body>
<div id="container">
    <div id="map"></div>
    <div id="sidebar">
        <h2>Nowe zgłoszenie</h2>
        <div class="form-group">
            <label for="tier">Priorytet:</label>
            <select id="tier">
                <option value="1">Tier 1 (Niski)</option>
                <option value="2">Tier 2 (Średni)</option>
                <option value="3">Tier 3 (Wysoki)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="description">Opis:</label>
            <textarea id="description" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="contact">Kontakt:</label>
            <input type="text" id="contact">
        </div>
        <div class="form-group">
            <label for="status">Status:</label>
            <select id="status">
                <option value="nowe">Nowe</option>
                <option value="w toku">W toku</option>
                <option value="zakończone">Zakończone</option>
            </select>
        </div>
        <div class="form-group">
            <p id="coordsDisplay">Nie wybrano lokalizacji</p>
        </div>
        <button id="createReport">Utwórz zgłoszenie</button>
        
        <h2>Zmień callsign jednostki</h2>
        <div class="form-group">
            <label for="unitIdInput">ID jednostki:</label>
            <input type="text" id="unitIdInput">
        </div>
        <div class="form-group">
            <label for="newCallsignInput">Nowy callsign:</label>
            <input type="text" id="newCallsignInput">
        </div>
        <button id="changeCallsignBtn">Zmień callsign</button>
        
        <h2>Zgłoszenia</h2>
        <div id="reportsList"></div>
        
        <h2>Jednostki</h2>
        <div id="unitsList"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Użyj dynamicznego URL serwera
// Użyj dynamicznego URL serwera
const SERVER_URL = window.location.origin;
const map = L.map('map').setView([52.0, 19.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
}).addTo(map);

let markersReports = {};
let markersUnits = {};
let reports = [];
let units = {};
let selectedLatLng = null;

// Style kółek dla jednostek w zależności od statusu
const unitCircleStyles = {
    available: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 10 },
    unavailable: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 10 },
    'on-intervention': { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 10 }
};

// Style kółek dla zgłoszeń w zależności od tieru
const reportCircleStyles = {
    1: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 12 },
    2: { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 12 },
    3: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 12 }
};

// --- Kliknięcie na mapie ustawia lokalizację zgłoszenia ---
map.on('click', (e) => {
    selectedLatLng = e.latlng;
    document.getElementById('coordsDisplay').innerText = `Wybrano lokalizację: ${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
});

// --- Dodawanie zgłoszenia ---
async function addReport(report) {
    try {
        const response = await fetch(`${SERVER_URL}/reports`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(report)
        });
        
        const result = await response.json();
        if (result.status === 'ok') {
            reports.push(report);
            
            // Koło dla zgłoszenia z odpowiednim kolorem
            const circle = L.circleMarker([report.lat, report.lng], reportCircleStyles[report.tier])
                .addTo(map)
                .bindPopup(`
                    <b>Zgłoszenie #${report.id}</b><br>
                    <b>Tier:</b> ${report.tier}<br>
                    <b>Opis:</b> ${report.description}<br>
                    <b>Kontakt:</b> ${report.contact}<br>
                    <b>Status:</b> ${report.status}
                    ${report.assignedUnits && report.assignedUnits.length > 0 
                        ? `<br><b>Przypisane jednostki:</b> ${report.assignedUnits.join(', ')}` 
                        : ''}
                    <br><button onclick="deleteReport('${report.id}')">Usuń zgłoszenie</button>
                `);
            
            markersReports[report.id] = circle;
            renderReports();
        }
    } catch (error) {
        console.error('Błąd dodawania zgłoszenia:', error);
        alert('Błąd dodawania zgłoszenia. Sprawdź konsolę dla szczegółów.');
    }
}

// --- Usuwanie zgłoszenia ---
async function deleteReport(reportId) {
    if (confirm('Czy na pewno chcesz usunąć to zgłoszenie?')) {
        try {
            const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                // Zwolnij wszystkie przypisane jednostki
                const report = reports.find(r => r.id === reportId);
                if (report && report.assignedUnits) {
                    report.assignedUnits.forEach(unitId => {
                        changeUnitStatus(unitId, 'available');
                    });
                }
                
                // Usuń znacznik z mapy
                if (markersReports[reportId]) {
                    map.removeLayer(markersReports[reportId]);
                    delete markersReports[reportId];
                }
                
                // Usuń zgłoszenie z listy
                reports = reports.filter(report => report.id !== reportId);
                renderReports();
            }
        } catch (error) {
            console.error('Błąd usuwania zgłoszenia:', error);
        }
    }
}

// --- Render listy zgłoszeń ---
function renderReports() {
    const container = document.getElementById('reportsList');
    container.innerHTML = '';
    
    // Sortowanie zgłoszeń - najnowsze na górze
    const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedReports.forEach(report => {
        const div = document.createElement('div');
        div.className = `report-item tier-${report.tier}`;
        div.innerHTML = `
            <strong>Zgłoszenie #${report.id}</strong>
            <button class="delete-btn" onclick="deleteReport('${report.id}')">X</button><br>
            Tier ${report.tier} | ${report.description.slice(0,30)}...<br>
            Status: ${report.status}
        `;
        
        // Wyświetl przypisane jednostki z przyciskami do usunięcia
        if (report.assignedUnits && report.assignedUnits.length > 0) {
            const unitsList = document.createElement('div');
            unitsList.innerHTML = '<br><strong>Przypisane jednostki:</strong><br>';
            
            report.assignedUnits.forEach(unitId => {
                const unitName = units[unitId]?.name || unitId;
                const unitItem = document.createElement('div');
                unitItem.innerHTML = `
                    ${unitName}
                    <button class="delete-btn" onclick="removeUnitFromReport('${report.id}', '${unitId}')" 
                            style="font-size: 0.7em; padding: 2px 5px;">X</button>
                `;
                unitsList.appendChild(unitItem);
            });
            
            div.appendChild(unitsList);
        }
        
        // Przycisk przypisania jednostki
        const btn = document.createElement('button');
        btn.className = 'assign-btn';
        btn.innerText = 'Przypisz jednostkę';
        btn.onclick = () => assignUnitToReport(report.id);
        div.appendChild(btn);
        
        div.onclick = () => {
            map.setView([report.lat, report.lng], 16);
            markersReports[report.id].openPopup();
        };
        
        container.appendChild(div);
    });
}

// --- Dodawanie / aktualizacja jednostek ---
async function updateUnit(unitData) {
    try {
        const response = await fetch(`${SERVER_URL}/units/${unitData.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(unitData)
        });
        
        const result = await response.json();
        if (result.status === 'ok') {
            const id = unitData.id;
            units[id] = unitData;

            // Aktualizuj koło jednostki
            if (markersUnits[id]) {
                markersUnits[id].setLatLng([unitData.lat, unitData.lng]);
                markersUnits[id].setStyle(unitCircleStyles[unitData.status] || unitCircleStyles.available);
                
                // Aktualizuj popup
                markersUnits[id].setPopupContent(`
                    <b>${unitData.name} (${id})</b><br>
                    Status: ${unitData.status}<br>
                    Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
                `);
            } else {
                const circle = L.circleMarker([unitData.lat, unitData.lng], unitCircleStyles[unitData.status] || unitCircleStyles.available)
                    .addTo(map)
                    .bindPopup(`
                        <b>${unitData.name} (${id})</b><br>
                        Status: ${unitData.status}<br>
                        Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
                    `);
                markersUnits[id] = circle;
            }

            renderUnits();
        }
    } catch (error) {
        console.error('Błąd aktualizacji jednostki:', error);
    }
}

// --- Render listy jednostek ---
function renderUnits() {
    const container = document.getElementById('unitsList');
    container.innerHTML = '';
    
    Object.values(units).forEach(unit => {
        const div = document.createElement('div');
        div.className = `unit-item ${unit.status || 'available'}`;
        div.innerHTML = `
            <strong>${unit.id}</strong>
            <button class="delete-btn" onclick="deleteUnit('${unit.id}')" style="font-size: 0.7em; padding: 2px 5px;">X</button><br>
            ${unit.name}<br>
            Status: ${unit.status || 'available'}
        `;
        
        // Przyciski zmiany statusu
        const statuses = ['available', 'unavailable', 'on-intervention'];
        statuses.forEach(status => {
            if (unit.status !== status) {
                const btn = document.createElement('button');
                btn.className = 'unit-status-btn';
                btn.innerText = status === 'available' ? 'Dostępny' : 
                               status === 'unavailable' ? 'Niedostępny' : 'Na interwencji';
                btn.onclick = () => changeUnitStatus(unit.id, status);
                div.appendChild(btn);
            }
        });
        
        div.onclick = () => {
            map.setView([unit.lat, unit.lng], 16);
            markersUnits[unit.id].openPopup();
        };
        
        container.appendChild(div);
    });
}

// --- Usuwanie jednostki ---
async function deleteUnit(unitId) {
    if (confirm('Czy na pewno chcesz usunąć tę jednostkę?')) {
        try {
            // Usuń jednostkę z wszystkich zgłoszeń
            reports.forEach(report => {
                if (report.assignedUnits && report.assignedUnits.includes(unitId)) {
                    report.assignedUnits = report.assignedUnits.filter(id => id !== unitId);
                    // Aktualizuj zgłoszenie na serwerze
                    fetch(`${SERVER_URL}/reports/${report.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(report)
                    });
                }
            });
            
            // Usuń jednostkę z listy
            delete units[unitId];
            
            // Usuń znacznik z mapy
            if (markersUnits[unitId]) {
                map.removeLayer(markersUnits[unitId]);
                delete markersUnits[unitId];
            }
            
            // Aktualizuj serwer
            await fetch(`${SERVER_URL}/units/${unitId}`, {
                method: 'DELETE'
            });
            
            renderUnits();
            renderReports();
        } catch (error) {
            console.error('Błąd usuwania jednostki:', error);
        }
    }
}

// --- Zmiana statusu jednostki ---
function changeUnitStatus(unitId, newStatus) {
    if (units[unitId]) {
        units[unitId].status = newStatus;
        updateUnit(units[unitId]);
    }
}

// --- Zmiana callsignu jednostki ---
function changeUnitCallsign(unitId, newCallsign) {
    if (units[unitId]) {
        units[unitId].name = newCallsign;
        updateUnit(units[unitId]);
        alert(`Callsign jednostki ${unitId} zmieniony na: ${newCallsign}`);
    } else {
        alert(`Jednostka o ID ${unitId} nie istnieje!`);
    }
}

// --- Przypisanie jednostki do zgłoszenia ---
async function assignUnitToReport(reportId) {
    const availableUnits = Object.values(units).filter(u => u.status === 'available');
    if (availableUnits.length === 0) {
        alert('Brak dostępnych jednostek do przypisania!');
        return;
    }
    
    const unitList = availableUnits.map(u => `${u.id} (${u.name})`).join('\n');
    const userInput = prompt('Podaj ID LUB callsign jednostki do przypisania:\nDostępne jednostki:\n' + unitList);
    
    if (!userInput) return;
    
    // Szukaj jednostki po ID lub callsign
    let unitToAssign = null;
    
    // Najpierw sprawdź po ID
    if (units[userInput]) {
        unitToAssign = units[userInput];
    } else {
        // Jeśli nie znaleziono po ID, szukaj po callsign
        unitToAssign = Object.values(units).find(u => u.name === userInput);
    }
    
    if (unitToAssign) {
        const reportIndex = reports.findIndex(r => r.id === reportId);
        if (reportIndex !== -1) {
            // Inicjalizuj tablicę assignedUnits jeśli nie istnieje
            if (!reports[reportIndex].assignedUnits) {
                reports[reportIndex].assignedUnits = [];
            }
            
            // Sprawdź czy jednostka już jest przypisana
            if (reports[reportIndex].assignedUnits.includes(unitToAssign.id)) {
                alert('Ta jednostka jest już przypisana do tego zgłoszenia!');
                return;
            }
            
            // Dodaj jednostkę do zgłoszenia
            reports[reportIndex].assignedUnits.push(unitToAssign.id);
            
            // Aktualizuj zgłoszenie na serwerze
            try {
                const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reports[reportIndex])
                });
                
                const result = await response.json();
                if (result.status === 'ok') {
                    // Zmień status jednostki na "na interwencji"
                    changeUnitStatus(unitToAssign.id, 'on-intervention');
                    renderReports();
                }
            } catch (error) {
                console.error('Błąd przypisywania jednostki:', error);
            }
        }
    } else {
        alert(`Nie znaleziono jednostki o ID/callsign: ${userInput}`);
    }
}

// --- Usuwanie jednostki ze zgłoszenia ---
async function removeUnitFromReport(reportId, unitId) {
    const reportIndex = reports.findIndex(r => r.id === reportId);
    if (reportIndex !== -1 && reports[reportIndex].assignedUnits) {
        // Usuń jednostkę z listy przypisanych
        reports[reportIndex].assignedUnits = reports[reportIndex].assignedUnits.filter(id => id !== unitId);
        
        // Aktualizuj zgłoszenie na serwerze
        try {
            const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reports[reportIndex])
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                // Zmień status jednostki na "dostępny"
                changeUnitStatus(unitId, 'available');
                renderReports();
            }
        } catch (error) {
            console.error('Błąd usuwania jednostki ze zgłoszenia:', error);
        }
    }
}

// --- Pobieranie danych z serwera ---
async function fetchData() {
    try {
        // Pobierz wszystkie dane równolegle
        const [positionsResponse, reportsResponse, unitsResponse] = await Promise.all([
            fetch(`${SERVER_URL}/positions`),
            fetch(`${SERVER_URL}/reports`),
            fetch(`${SERVER_URL}/units`)
        ]);

        if (!positionsResponse.ok || !reportsResponse.ok || !unitsResponse.ok) {
            throw new Error('Błąd pobierania danych');
        }

        const [positionsData, reportsData, unitsData] = await Promise.all([
            positionsResponse.json(),
            reportsResponse.json(),
            unitsResponse.json()
        ]);

        // Aktualizuj jednostki
        Object.entries(positionsData).forEach(([id, unitData]) => {
            const existingStatus = units[id]?.status || 'available';
            const existingName = units[id]?.name || id;
            
            if (!units[id] || units[id].lat !== unitData.lat || units[id].lng !== unitData.lng) {
                updateUnit({
                    id: id,
                    name: existingName,
                    lat: unitData.lat,
                    lng: unitData.lng,
                    status: existingStatus,
                    timestamp: unitData.timestamp
                });
            }
        });

        // Aktualizuj zgłoszenia
        reports = reportsData;
        renderReports();
        
        // Aktualizuj znaczniki zgłoszeń
        reports.forEach(report => {
            if (!markersReports[report.id]) {
                const circle = L.circleMarker([report.lat, report.lng], reportCircleStyles[report.tier])
                    .addTo(map)
                    .bindPopup(`
                        <b>Zgłoszenie #${report.id}</b><br>
                        <b>Tier:</b> ${report.tier}<br>
                        <b>Opis:</b> ${report.description}<br>
                        <b>Kontakt:</b> ${report.contact}<br>
                        <b>Status:</b> ${report.status}
                        ${report.assignedUnits && report.assignedUnits.length > 0 
                            ? `<br><b>Przypisane jednostki:</b> ${report.assignedUnits.join(', ')}` 
                            : ''}
                        <br><button onclick="deleteReport('${report.id}')">Usuń zgłoszenie</button>
                    `);
                
                markersReports[report.id] = circle;
            }
        });

    } catch (error) {
        console.error('Błąd pobierania danych:', error);
    }
}

// --- Obsługa przycisku tworzenia zgłoszenia ---
document.getElementById('createReport').addEventListener('click', () => {
    const tier = document.getElementById('tier').value;
    const description = document.getElementById('description').value;
    const contact = document.getElementById('contact').value;
    const status = document.getElementById('status').value;

    if (!selectedLatLng) return alert('Kliknij na mapie, aby ustawić lokalizację zgłoszenia!');
    if (!description) return alert('Podaj opis zgłoszenia!');

    // Generuj trzycyfrowe ID (001, 002, ..., 999)
    const nextId = reports.length > 0 
        ? Math.max(...reports.map(r => parseInt(r.id))) + 1 
        : 1;
    
    const reportId = nextId.toString().padStart(3, '0');
    
    const report = {
        id: reportId,
        tier, description, contact, status,
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        timestamp: Date.now(),
        assignedUnits: []  // Teraz to tablica, nie pojedyncza wartość
    };

    addReport(report);

    // Reset
    document.getElementById('description').value = '';
    document.getElementById('contact').value = '';
    selectedLatLng = null;
    document.getElementById('coordsDisplay').innerText = 'Nie wybrano lokalizacji';
});

// --- Obsługa zmiany callsignu ---
document.getElementById('changeCallsignBtn').addEventListener('click', () => {
    const unitId = document.getElementById('unitIdInput').value;
    const newCallsign = document.getElementById('newCallsignInput').value;
    
    if (!unitId) return alert('Podaj ID jednostki!');
    if (!newCallsign) return alert('Podaj nowy callsign!');
    
    changeUnitCallsign(unitId, newCallsign);
    
    // Reset formularza
    document.getElementById('unitIdInput').value = '';
    document.getElementById('newCallsignInput').value = '';
});

// Regularne pobieranie danych co 5 sekund
setInterval(fetchData, 5000);

// Inicjalizacja przy starcie
document.addEventListener('DOMContentLoaded', () => {
    console.log('Aplikacja inicjalizowana...');
    fetchData();
});
</script>
</body>
</html>
