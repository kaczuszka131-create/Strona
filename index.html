<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Centrum Dyspozytorskie</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body, html { margin: 0; height: 100%; font-family: Arial, sans-serif; }
    #container { display: flex; height: 100%; }
    #map { flex: 1; height: 100%; }
    #sidebar {
        width: 360px;
        background: #f7f7f7;
        padding: 10px;
        box-shadow: -2px 0 5px rgba(0,0,0,0.2);
        overflow-y: auto;
    }
    h2 { margin-top: 0; font-size: 18px; }
    label { display: block; margin-top: 8px; font-weight: bold; }
    input, select, textarea, button { width: 100%; margin-top: 4px; padding: 5px; font-size: 14px; }
    textarea { resize: vertical; }
    .report-item, .unit-item {
        padding: 6px 8px;
        margin-bottom: 6px;
        border-radius: 5px;
        background: #fff;
        border-left: 4px solid #007bff;
        cursor: pointer;
        position: relative;
    }
    .report-item.tier-1 { border-left-color: green; }
    .report-item.tier-2 { border-left-color: orange; }
    .report-item.tier-3 { border-left-color: red; }
    .unit-item { border-left-color: #007bff; }
    .unit-item.available { background: #e0f0ff; border-left-color: green; }
    .unit-item.unavailable { background: #ffe0e0; border-left-color: red; }
    .unit-item.on-intervention { background: #fff0e0; border-left-color: orange; }
    #coordsDisplay { font-size: 12px; color: #555; margin-top: 4px; }
    .assign-btn, .delete-btn {
        margin-top: 4px;
        color: white;
        border: none;
        padding: 3px 6px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
    }
    .assign-btn {
        background: #007bff;
    }
    .delete-btn {
        background: #dc3545;
    }
    .unit-status-btn {
        margin-top: 4px;
        margin-right: 4px;
        padding: 3px 6px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
        border: 1px solid #ccc;
    }
    .callsign-edit {
        display: flex;
        margin-top: 8px;
    }
    .callsign-edit input {
        flex: 1;
        margin-right: 4px;
    }
    .callsign-edit button {
        width: auto;
    }
    .loading {
        color: #666;
        font-style: italic;
    }
    .error {
        color: red;
        font-weight: bold;
    }
    .connection-status {
        position: fixed;
        bottom: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
    }
    .connection-online {
        background-color: #d4edda;
        color: #155724;
    }
    .connection-offline {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
</head>
<body>
<div id="container">
    <div id="map"></div>
    <div id="sidebar">
        <h2>Tworzenie zgłoszenia</h2>
        <label for="tier">Tier zgłoszenia:</label>
        <select id="tier">
            <option value="1">1 - Niski priorytet</option>
            <option value="2">2 - Średni priorytet</option>
            <option value="3">3 - Wysoki priorytet</option>
        </select>

        <label for="description">Opis:</label>
        <textarea id="description" rows="3"></textarea>

        <label for="contact">Kontakt:</label>
        <input type="text" id="contact" placeholder="Numer telefonu">

        <label for="status">Status:</label>
        <select id="status">
            <option value="Otwarty">Otwarty</option>
            <option value="W trakcie">W trakcie</option>
            <option value="Zamknięty">Zamknięty</option>
        </select>

        <button id="createReport">Stwórz zgłoszenie</button>
        <div id="coordsDisplay">Nie wybrano lokalizacji</div>

        <h2>Lista zgłoszeń</h2>
        <div id="reportsList" class="loading">Ładowanie zgłoszeń...</div>

        <h2>Lista jednostek</h2>
        <div id="unitsList" class="loading">Ładowanie jednostek...</div>
        
        <h2>Zarządzanie callsignami</h2>
        <div class="callsign-edit">
            <input type="text" id="unitIdInput" placeholder="ID jednostki">
            <input type="text" id="newCallsignInput" placeholder="Nowy callsign">
            <button id="changeCallsignBtn">Zmień</button>
        </div>
    </div>
</div>

<div id="connectionStatus" class="connection-status connection-offline">Brak połączenia z serwerem</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Konfiguracja serwera - jeśli główny serwer nie działa, używamy mock danych
const SERVER_CONFIG = {
    primary: 'https://dyspo.onrender.com',
    fallbackToMock: true // czy używać mock danych gdy serwer nie odpowiada
};

let SERVER_URL = SERVER_CONFIG.primary;
let usingMockData = false;
const map = L.map('map').setView([52.0, 19.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
}).addTo(map);

let markersReports = {};
let markersUnits = {};
let reports = [];
let units = {};
let selectedLatLng = null;

// Style kółek dla jednostek w zależności od statusu
const unitCircleStyles = {
    available: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 10 },
    unavailable: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 10 },
    'on-intervention': { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 10 }
};

// Style kółek dla zgłoszeń w zależności od tieru
const reportCircleStyles = {
    1: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 12 },
    2: { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 12 },
    3: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 12 }
};

// Mock danych dla trybu offline
const mockUnits = {
    'unit1': { id: 'unit1', name: 'R-01', lat: 52.2297, lng: 21.0122, status: 'available', timestamp: Date.now() },
    'unit2': { id: 'unit2', name: 'R-02', lat: 52.4064, lng: 16.9252, status: 'available', timestamp: Date.now() },
    'unit3': { id: 'unit3', name: 'R-03', lat: 51.1079, lng: 17.0385, status: 'unavailable', timestamp: Date.now() }
};

const mockReports = [
    { id: '001', tier: '2', description: 'Awaria sygnalizacji świetlnej', contact: '123-456-789', status: 'Otwarty', lat: 52.2297, lng: 21.0122, timestamp: Date.now() - 3600000 },
    { id: '002', tier: '1', description: 'Uszkodzona ławka w parku', contact: '987-654-321', status: 'W trakcie', lat: 52.4064, lng: 16.9252, timestamp: Date.now() - 1800000, assignedUnit: 'unit2' }
];

// --- Aktualizacja statusu połączenia ---
function updateConnectionStatus(isOnline) {
    const statusElement = document.getElementById('connectionStatus');
    if (isOnline) {
        statusElement.textContent = 'Połączono z serwerem';
        statusElement.className = 'connection-status connection-online';
    } else {
        statusElement.textContent = 'Brak połączenia z serwerem - tryb offline';
        statusElement.className = 'connection-status connection-offline';
    }
}

// --- Sprawdzenie czy serwer jest dostępny ---
async function checkServerStatus() {
    try {
        const response = await fetch(`${SERVER_URL}/health`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            timeout: 5000
        });
        
        if (response.ok) {
            updateConnectionStatus(true);
            usingMockData = false;
            return true;
        }
    } catch (error) {
        console.warn('Serwer niedostępny, używam mock danych', error);
        if (SERVER_CONFIG.fallbackToMock) {
            usingMockData = true;
            updateConnectionStatus(false);
            return false;
        }
    }
    return false;
}

// --- Kliknięcie na mapie ustawia lokalizację zgłoszenia ---
map.on('click', (e) => {
    selectedLatLng = e.latlng;
    document.getElementById('coordsDisplay').innerText = `Wybrano lokalizację: ${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
});

// --- Dodawanie zgłoszenia ---
function addReport(report) {
    // Sprawdź czy zgłoszenie już istnieje
    const existingIndex = reports.findIndex(r => r.id === report.id);
    if (existingIndex >= 0) {
        reports[existingIndex] = report;
    } else {
        reports.push(report);
    }
    
    // Aktualizuj marker na mapie
    if (markersReports[report.id]) {
        map.removeLayer(markersReports[report.id]);
    }
    
    // Koło dla zgłoszenia z odpowiednim kolorem
    const circle = L.circleMarker([report.lat, report.lng], reportCircleStyles[report.tier])
        .addTo(map)
        .bindPopup(`
            <b>Zgłoszenie #${report.id}</b><br>
            <b>Tier:</b> ${report.tier}<br>
            <b>Opis:</b> ${report.description}<br>
            <b>Kontakt:</b> ${report.contact}<br>
            <b>Status:</b> ${report.status}
            ${report.assignedUnit ? `<br><b>Przypisana jednostka:</b> ${report.assignedUnit}` : ''}
            <br><button onclick="deleteReport('${report.id}')">Usuń zgłoszenie</button>
        `);
    
    markersReports[report.id] = circle;
    renderReports();
}

// --- Usuwanie zgłoszenia ---
async function deleteReport(reportId) {
    if (confirm('Czy na pewno chcesz usunąć to zgłoszenie?')) {
        try {
            if (!usingMockData) {
                // Usuń zgłoszenie z serwera
                const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Błąd serwera');
                }
            }
            
            // Usuń znacznik z mapy
            if (markersReports[reportId]) {
                map.removeLayer(markersReports[reportId]);
                delete markersReports[reportId];
            }
            
            // Usuń zgłoszenie z listy
            reports = reports.filter(report => report.id !== reportId);
            renderReports();
        } catch (error) {
            console.error('Błąd podczas usuwania zgłoszenia:', error);
            // Nawet jeśli serwer nie odpowiedział, usuwamy lokalnie
            if (markersReports[reportId]) {
                map.removeLayer(markersReports[reportId]);
                delete markersReports[reportId];
            }
            reports = reports.filter(report => report.id !== reportId);
            renderReports();
            alert('Zgłoszenie usunięte lokalnie, ale wystąpił problem z synchronizacją z serwerem.');
        }
    }
}

// --- Render listy zgłoszeń ---
function renderReports() {
    const container = document.getElementById('reportsList');
    container.innerHTML = '';
    
    if (reports.length === 0) {
        container.innerHTML = '<div class="loading">Brak zgłoszeń</div>';
        return;
    }
    
    // Sortowanie zgłoszeń - najnowsze na górze
    const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedReports.forEach(report => {
        const div = document.createElement('div');
        div.className = `report-item tier-${report.tier}`;
        div.innerHTML = `
            <strong>Zgłoszenie #${report.id}</strong>
            <button class="delete-btn" onclick="deleteReport('${report.id}')">X</button><br>
            Tier ${report.tier} | ${report.description.slice(0,30)}...<br>
            Status: ${report.status}
        `;
        
        // Przypisz jednostkę
        if (!report.assignedUnit) {
            const btn = document.createElement('button');
            btn.className = 'assign-btn';
            btn.innerText = 'Przypisz jednostkę';
            btn.onclick = () => assignUnitToReport(report.id);
            div.appendChild(btn);
        } else {
            div.innerHTML += `<br>Przypisana jednostka: ${report.assignedUnit}`;
            
            // Przycisk zwolnienia jednostki
            const releaseBtn = document.createElement('button');
            releaseBtn.className = 'assign-btn';
            releaseBtn.innerText = 'Zwolnij jednostkę';
            releaseBtn.style.background = '#dc3545';
            releaseBtn.onclick = () => releaseUnitFromReport(report.id);
            div.appendChild(releaseBtn);
        }
        
        div.onclick = () => {
            map.setView([report.lat, report.lng], 16);
            if (markersReports[report.id]) {
                markersReports[report.id].openPopup();
            }
        };
        
        container.appendChild(div);
    });
}

// --- Dodawanie / aktualizacja jednostek ---
function updateUnit(unitData) {
    const id = unitData.id;
    units[id] = unitData;

    // Aktualizuj koło jednostki
    if (markersUnits[id]) {
        markersUnits[id].setLatLng([unitData.lat, unitData.lng]);
        markersUnits[id].setStyle(unitCircleStyles[unitData.status] || unitCircleStyles.available);
        
        // Aktualizuj popup
        markersUnits[id].setPopupContent(`
            <b>${unitData.name} (${id})</b><br>
            Status: ${unitData.status}<br>
            Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
        `);
    } else {
        const circle = L.circleMarker([unitData.lat, unitData.lng], unitCircleStyles[unitData.status] || unitCircleStyles.available)
            .addTo(map)
            .bindPopup(`
                <b>${unitData.name} (${id})</b><br>
                Status: ${unitData.status}<br>
                Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
            `);
        markersUnits[id] = circle;
    }

    renderUnits();
}

// --- Render listy jednostek ---
function renderUnits() {
    const container = document.getElementById('unitsList');
    container.innerHTML = '';
    
    const unitList = Object.values(units);
    
    if (unitList.length === 0) {
        container.innerHTML = '<div class="loading">Brak jednostek</div>';
        return;
    }
    
    unitList.forEach(unit => {
        const div = document.createElement('div');
        div.className = `unit-item ${unit.status || 'available'}`;
        div.innerHTML = `
            <strong>${unit.id}</strong><br>
            ${unit.name}<br>
            Status: ${unit.status || 'available'}
        `;
        
        // Przyciski zmiany statusu
        const statuses = ['available', 'unavailable', 'on-intervention'];
        statuses.forEach(status => {
            if (unit.status !== status) {
                const btn = document.createElement('button');
                btn.className = 'unit-status-btn';
                btn.innerText = status === 'available' ? 'Dostępny' : 
                               status === 'unavailable' ? 'Niedostępny' : 'Na interwencji';
                btn.onclick = () => changeUnitStatus(unit.id, status);
                div.appendChild(btn);
            }
        });
        
        div.onclick = () => {
            map.setView([unit.lat, unit.lng], 16);
            if (markersUnits[unit.id]) {
                markersUnits[unit.id].openPopup();
            }
        };
        
        container.appendChild(div);
    });
}

// --- Zmiana statusu jednostki ---
async function changeUnitStatus(unitId, newStatus) {
    if (units[unitId]) {
        try {
            if (!usingMockData) {
                // Aktualizuj status na serwerze
                const response = await fetch(`${SERVER_URL}/units/${unitId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    throw new Error('Błąd serwera');
                }
            }
            
            // Aktualizuj lokalnie po potwierdzeniu z serwera
            units[unitId].status = newStatus;
            updateUnit(units[unitId]);
        } catch (error) {
            console.error('Błąd aktualizacji statusu jednostki:', error);
            // Aktualizuj lokalnie nawet jeśli serwer nie odpowiedział
            units[unitId].status = newStatus;
            updateUnit(units[unitId]);
            alert('Status zmieniony lokalnie, ale wystąpił problem z synchronizacją z serwerem.');
        }
    }
}

// --- Zmiana callsignu jednostki ---
async function changeUnitCallsign(unitId, newCallsign) {
    if (units[unitId]) {
        try {
            if (!usingMockData) {
                // Aktualizuj callsign na serwerze
                const response = await fetch(`${SERVER_URL}/units/${unitId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newCallsign })
                });
                
                if (!response.ok) {
                    throw new Error('Błąd serwera');
                }
            }
            
            // Aktualizuj lokalnie po potwierdzeniu z serwera
            units[unitId].name = newCallsign;
            updateUnit(units[unitId]);
            alert(`Callsign jednostki ${unitId} zmieniony na: ${newCallsign}`);
        } catch (error) {
            console.error('Błąd zmiany callsignu:', error);
            // Aktualizuj lokalnie nawet jeśli serwer nie odpowiedział
            units[unitId].name = newCallsign;
            updateUnit(units[unitId]);
            alert('Callsign zmieniony lokalnie, ale wystąpił problem z synchronizacją z serwerem.');
        }
    } else {
        alert(`Jednostka o ID ${unitId} nie istnieje!`);
    }
}

// --- Przypisanie jednostki do zgłoszenia ---
async function assignUnitToReport(reportId) {
    const availableUnits = Object.values(units).filter(u => u.status === 'available');
    if (availableUnits.length === 0) {
        alert('Brak dostępnych jednostek do przypisania!');
        return;
    }
    
    const unitList = availableUnits.map(u => `${u.id} (${u.name})`).join('\n');
    const userInput = prompt('Podaj ID LUB callsign jednostki do przypisania:\nDostępne jednostki:\n' + unitList);
    
    if (!userInput) return;
    
    // Szukaj jednostki po ID lub callsign
    let unitToAssign = null;
    
    // Najpierw sprawdź po ID
    if (units[userInput]) {
        unitToAssign = units[userInput];
    } else {
        // Jeśli nie znaleziono po ID, szukaj po callsign
        unitToAssign = Object.values(units).find(u => u.name === userInput);
    }
    
    if (unitToAssign) {
        try {
            if (!usingMockData) {
                // Aktualizuj zgłoszenie na serwerze
                const reportResponse = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ assignedUnit: unitToAssign.id })
                });
                
                if (!reportResponse.ok) {
                    throw new Error('Błąd serwera przy aktualizacji zgłoszenia');
                }
                
                // Aktualizuj status jednostki na serwerze
                const unitResponse = await fetch(`${SERVER_URL}/units/${unitToAssign.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'on-intervention' })
                });
                
                if (!unitResponse.ok) {
                    throw new Error('Błąd serwera przy aktualizacji jednostki');
                }
            }
            
            // Aktualizuj lokalnie po potwierdzeniu z serwera
            const report = reports.find(r => r.id === reportId);
            if (report) {
                report.assignedUnit = unitToAssign.id;
                // Zmień status jednostki na "na interwencji"
                units[unitToAssign.id].status = 'on-intervention';
                updateUnit(units[unitToAssign.id]);
                renderReports();
            }
        } catch (error) {
            console.error('Błąd przypisywania jednostki:', error);
            // Aktualizuj lokalnie nawet jeśli serwer nie odpowiedział
            const report = reports.find(r => r.id === reportId);
            if (report) {
                report.assignedUnit = unitToAssign.id;
                units[unitToAssign.id].status = 'on-intervention';
                updateUnit(units[unitToAssign.id]);
                renderReports();
                alert('Jednostka przypisana lokalnie, ale wystąpił problem z synchronizacją z serwerem.');
            }
        }
    } else {
        alert(`Nie znaleziono jednostki o ID/callsign: ${userInput}`);
    }
}

// --- Zwolnienie jednostki ze zgłoszenia ---
async function releaseUnitFromReport(reportId) {
    const report = reports.find(r => r.id === reportId);
    if (report && report.assignedUnit) {
        try {
            if (!usingMockData) {
                // Aktualizuj zgłoszenie na serwerze
                const reportResponse = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ assignedUnit: null })
                });
                
                if (!reportResponse.ok) {
                    throw new Error('Błąd serwera przy aktualizacji zgłoszenia');
                }
                
                // Aktualizuj status jednostki na serwerze
                const unitResponse = await fetch(`${SERVER_URL}/units/${report.assignedUnit}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'available' })
                });
                
                if (!unitResponse.ok) {
                    throw new Error('Błąd serwera przy aktualizacji jednostki');
                }
            }
            
            // Aktualizuj lokalnie po potwierdzeniu z serwera
            const unitId = report.assignedUnit;
            report.assignedUnit = null;
            // Zmień status jednostki na "dostępny"
            units[unitId].status = 'available';
            updateUnit(units[unitId]);
            renderReports();
        } catch (error) {
            console.error('Błąd zwalniania jednostki:', error);
            // Aktualizuj lokalnie nawet jeśli serwer nie odpowiedział
            const unitId = report.assignedUnit;
            report.assignedUnit = null;
            units[unitId].status = 'available';
            updateUnit(units[unitId]);
            renderReports();
            alert('Jednostka zwolniona lokalnie, ale wystąpił problem z synchronizacją z serwerem.');
        }
    }
}

// --- Obsługa przycisku tworzenia zgłoszenia ---
document.getElementById('createReport').addEventListener('click', async () => {
    const tier = document.getElementById('tier').value;
    const description = document.getElementById('description').value;
    const contact = document.getElementById('contact').value;
    const status = document.getElementById('status').value;

    if (!selectedLatLng) return alert('Kliknij na mapie, aby ustawić lokalizację zgłoszenia!');
    if (!description) return alert('Podaj opis zgłoszenia!');

    try {
        let newReport;
        
        if (!usingMockData) {
            // Wyślij zgłoszenie na serwer
            const response = await fetch(`${SERVER_URL}/reports`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tier,
                    description,
                    contact,
                    status,
                    lat: selectedLatLng.lat,
                    lng: selectedLatLng.lng
                })
            });
            
            if (!response.ok) {
                throw new Error('Błąd serwera');
            }
            
            newReport = await response.json();
        } else {
            // Tryb offline - generuj lokalne ID
            const nextId = reports.length > 0 
                ? Math.max(...reports.map(r => parseInt(r.id))) + 1 
                : 1;
            
            newReport = {
                id: nextId.toString().padStart(3, '0'),
                tier, 
                description, 
                contact, 
                status,
                lat: selectedLatLng.lat,
                lng: selectedLatLng.lng,
                timestamp: Date.now()
            };
        }
        
        // Dodaj zgłoszenie do lokalnej listy
        addReport(newReport);

        // Reset
        document.getElementById('description').value = '';
        document.getElementById('contact').value = '';
        selectedLatLng = null;
        document.getElementById('coordsDisplay').innerText = 'Nie wybrano lokalizacji';
    } catch (error) {
        console.error('Błąd tworzenia zgłoszenia:', error);
        alert('Błąd podczas tworzenia zgłoszenia. Sprawdź połączenie z serwerem.');
    }
});

// --- Obsługa zmiany callsignu ---
document.getElementById('changeCallsignBtn').addEventListener('click', () => {
    const unitId = document.getElementById('unitIdInput').value;
    const newCallsign = document.getElementById('newCallsignInput').value;
    
    if (!unitId) return alert('Podaj ID jednostki!');
    if (!newCallsign) return alert('Podaj nowy callsign!');
    
    changeUnitCallsign(unitId, newCallsign);
    
    // Reset formularza
    document.getElementById('unitIdInput').value = '';
    document.getElementById('newCallsignInput').value = '';
});

// --- Pobieranie zgłoszeń z serwera ---
async function fetchReports() {
    try {
        if (usingMockData) {
            // Użyj mock danych
            reports = [...mockReports];
            reports.forEach(addReport);
            return;
        }
        
        const response = await fetch(`${SERVER_URL}/reports`);
        if (response.ok) {
            const data = await response.json();
            reports = data;
            
            // Usuń wszystkie markery z mapy
            Object.values(markersReports).forEach(m => map.removeLayer(m));
            markersReports = {};
            
            // Dodaj markery od nowa
            reports.forEach(addReport);
        } else {
            throw new Error('Błąd odpowiedzi serwera');
        }
    } catch (error) {
        console.error('Błąd pobierania zgłoszeń:', error);
        if (SERVER_CONFIG.fallbackToMock) {
            usingMockData = true;
            updateConnectionStatus(false);
            reports = [...mockReports];
            reports.forEach(addReport);
        }
    }
}

// --- Pobieranie jednostek z serwera ---
async function fetchUnits() {
    try {
        if (usingMockData) {
            // Użyj mock danych
            Object.values(mockUnits).forEach(unit => updateUnit(unit));
            return;
        }
        
        const response = await fetch(`${SERVER_URL}/units`);
        if (response.ok) {
            const data = await response.json();
            
            // Aktualizuj jednostki na podstawie danych z serwera
            Object.entries(data).forEach(([id, unitData]) => {
                updateUnit({
                    id: id,
                    name: unitData.name || id,
                    lat: unitData.lat,
                    lng: unitData.lng,
                    status: unitData.status || 'available',
                    timestamp: unitData.timestamp
                });
            });
        } else {
            throw new Error('Błąd odpowiedzi serwera');
        }
    } catch (error) {
        console.error('Błąd pobierania jednostek:', error);
        if (SERVER_CONFIG.fallbackToMock) {
            usingMockData = true;
            updateConnectionStatus(false);
            Object.values(mockUnits).forEach(unit => updateUnit(unit));
        }
    }
}

// --- Pobieranie pozycji z serwera ---
async function fetchPositions() {
    try {
        if (usingMockData) {
            // W trybie mock symuluj ruch jednostek
            Object.values(units).forEach(unit => {
                // Losowa niewielka zmiana pozycji dla realizmu
                unit.lat += (Math.random() - 0.5) * 0.001;
                unit.lng += (Math.random() - 0.5) * 0.001;
                unit.timestamp = Date.now();
                updateUnit(unit);
            });
            return;
        }
        
        const response = await fetch(`${SERVER_URL}/positions`);
        if (response.ok) {
            const data = await response.json();
            
            // Aktualizuj pozycje jednostek na podstawie danych z serwera
            Object.entries(data).forEach(([id, unitData]) => {
                if (units[id]) {
                    // Zachowaj istniejący status i nazwę, aktualizuj tylko pozycję
                    updateUnit({
                        id: id,
                        name: units[id].name,
                        lat: unitData.lat,
                        lng: unitData.lng,
                        status: units[id].status,
                        timestamp: unitData.timestamp
                    });
                } else {
                    // Jeśli to nowa jednostka, dodaj ją z domyślnym statusem
                    updateUnit({
                        id: id,
                        name: id, // Domyślnie callsign to ID
                        lat: unitData.lat,
                        lng: unitData.lng,
                        status: 'available',
                        timestamp: unitData.timestamp
                    });
                }
            });
        } else {
            throw new Error('Błąd odpowiedzi serwera');
        }
    } catch (error) {
        console.error('Błąd pobierania pozycji:', error);
        if (SERVER_CONFIG.fallbackToMock) {
            usingMockData = true;
            updateConnectionStatus(false);
        }
    }
}

// Funkcja do okresowego odświeżania danych
function startDataRefresh() {
    // Sprawdź status serwera
    checkServerStatus().then(isOnline => {
        if (isOnline) {
            // Pobierz dane przy starcie
            fetchReports();
            fetchUnits();
            fetchPositions();
        }
    });
    
    // Ustaw okresowe odświeżanie
    setInterval(fetchReports, 10000);
    setInterval(fetchUnits, 10000);
    setInterval(fetchPositions, 5000);
    setInterval(checkServerStatus, 30000); // Sprawdzaj status serwera co 30 sekund
}

// Inicjalizacja przy starcie
document.addEventListener('DOMContentLoaded', startDataRefresh);
</script>
</body>
</html>
