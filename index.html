<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Centrum Dyspozytorskie</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    /* ... (stylowanie pozostaje bez zmian) ... */
</style>
</head>
<body>
<div id="container">
    <div id="map"></div>
    <div id="sidebar">
        <!-- ... (HTML pozostaje bez zmian) ... -->
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SERVER_URL = 'http://localhost:3000';
const map = L.map('map').setView([52.0, 19.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
}).addTo(map);

let markersReports = {};
let markersUnits = {};
let reports = [];
let units = {};
let selectedLatLng = null;

// Style kółek dla jednostek w zależności od statusu
const unitCircleStyles = {
    available: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 10 },
    unavailable: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 10 },
    'on-intervention': { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 10 }
};

// Style kółek dla zgłoszeń w zależności od tieru
const reportCircleStyles = {
    1: { color: 'green', fillColor: '#00ff00', fillOpacity: 0.7, radius: 12 },
    2: { color: 'orange', fillColor: '#ff9900', fillOpacity: 0.7, radius: 12 },
    3: { color: 'red', fillColor: '#ff0000', fillOpacity: 0.7, radius: 12 }
};

// --- Kliknięcie na mapie ustawia lokalizację zgłoszenia ---
map.on('click', (e) => {
    selectedLatLng = e.latlng;
    document.getElementById('coordsDisplay').innerText = `Wybrano lokalizację: ${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
});

// --- Dodawanie zgłoszenia ---
async function addReport(report) {
    try {
        const response = await fetch(`${SERVER_URL}/reports`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(report)
        });
        
        const result = await response.json();
        if (result.status === 'ok') {
            reports.push(report);
            
            // Koło dla zgłoszenia z odpowiednim kolorem
            const circle = L.circleMarker([report.lat, report.lng], reportCircleStyles[report.tier])
                .addTo(map)
                .bindPopup(`
                    <b>Zgłoszenie #${report.id}</b><br>
                    <b>Tier:</b> ${report.tier}<br>
                    <b>Opis:</b> ${report.description}<br>
                    <b>Kontakt:</b> ${report.contact}<br>
                    <b>Status:</b> ${report.status}
                    ${report.assignedUnit ? `<br><b>Przypisana jednostka:</b> ${report.assignedUnit}` : ''}
                    <br><button onclick="deleteReport('${report.id}')">Usuń zgłoszenie</button>
                `);
            
            markersReports[report.id] = circle;
            renderReports();
        }
    } catch (error) {
        console.error('Błąd dodawania zgłoszenia:', error);
    }
}

// --- Usuwanie zgłoszenia ---
async function deleteReport(reportId) {
    if (confirm('Czy na pewno chcesz usunąć to zgłoszenie?')) {
        try {
            const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                // Usuń znacznik z mapy
                if (markersReports[reportId]) {
                    map.removeLayer(markersReports[reportId]);
                    delete markersReports[reportId];
                }
                
                // Usuń zgłoszenie z listy
                reports = reports.filter(report => report.id !== reportId);
                renderReports();
            }
        } catch (error) {
            console.error('Błąd usuwania zgłoszenia:', error);
        }
    }
}

// --- Render listy zgłoszeń ---
function renderReports() {
    const container = document.getElementById('reportsList');
    container.innerHTML = '';
    
    // Sortowanie zgłoszeń - najnowsze na górze
    const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedReports.forEach(report => {
        const div = document.createElement('div');
        div.className = `report-item tier-${report.tier}`;
        div.innerHTML = `
            <strong>Zgłoszenie #${report.id}</strong>
            <button class="delete-btn" onclick="deleteReport('${report.id}')">X</button><br>
            Tier ${report.tier} | ${report.description.slice(0,30)}...<br>
            Status: ${report.status}
        `;
        
        // Przypisz jednostkę
        if (!report.assignedUnit) {
            const btn = document.createElement('button');
            btn.className = 'assign-btn';
            btn.innerText = 'Przypisz jednostkę';
            btn.onclick = () => assignUnitToReport(report.id);
            div.appendChild(btn);
        } else {
            div.innerHTML += `<br>Przypisana jednostka: ${report.assignedUnit}`;
            
            // Przycisk zwolnienia jednostki
            const releaseBtn = document.createElement('button');
            releaseBtn.className = 'assign-btn';
            releaseBtn.innerText = 'Zwolnij jednostkę';
            releaseBtn.style.background = '#dc3545';
            releaseBtn.onclick = () => releaseUnitFromReport(report.id);
            div.appendChild(releaseBtn);
        }
        
        div.onclick = () => {
            map.setView([report.lat, report.lng], 16);
            markersReports[report.id].openPopup();
        };
        
        container.appendChild(div);
    });
}

// --- Dodawanie / aktualizacja jednostek ---
async function updateUnit(unitData) {
    try {
        const response = await fetch(`${SERVER_URL}/units/${unitData.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(unitData)
        });
        
        const result = await response.json();
        if (result.status === 'ok') {
            const id = unitData.id;
            units[id] = unitData;

            // Aktualizuj koło jednostki
            if (markersUnits[id]) {
                markersUnits[id].setLatLng([unitData.lat, unitData.lng]);
                markersUnits[id].setStyle(unitCircleStyles[unitData.status] || unitCircleStyles.available);
                
                // Aktualizuj popup
                markersUnits[id].setPopupContent(`
                    <b>${unitData.name} (${id})</b><br>
                    Status: ${unitData.status}<br>
                    Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
                `);
            } else {
                const circle = L.circleMarker([unitData.lat, unitData.lng], unitCircleStyles[unitData.status] || unitCircleStyles.available)
                    .addTo(map)
                    .bindPopup(`
                        <b>${unitData.name} (${id})</b><br>
                        Status: ${unitData.status}<br>
                        Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
                    `);
                markersUnits[id] = circle;
            }

            renderUnits();
        }
    } catch (error) {
        console.error('Błąd aktualizacji jednostki:', error);
    }
}

// --- Render listy jednostek ---
function renderUnits() {
    const container = document.getElementById('unitsList');
    container.innerHTML = '';
    
    Object.values(units).forEach(unit => {
        const div = document.createElement('div');
        div.className = `unit-item ${unit.status || 'available'}`;
        div.innerHTML = `
            <strong>${unit.id}</strong><br>
            ${unit.name}<br>
            Status: ${unit.status || 'available'}
        `;
        
        // Przyciski zmiany statusu
        const statuses = ['available', 'unavailable', 'on-intervention'];
        statuses.forEach(status => {
            if (unit.status !== status) {
                const btn = document.createElement('button');
                btn.className = 'unit-status-btn';
                btn.innerText = status === 'available' ? 'Dostępny' : 
                               status === 'unavailable' ? 'Niedostępny' : 'Na interwencji';
                btn.onclick = () => changeUnitStatus(unit.id, status);
                div.appendChild(btn);
            }
        });
        
        div.onclick = () => {
            map.setView([unit.lat, unit.lng], 16);
            markersUnits[unit.id].openPopup();
        };
        
        container.appendChild(div);
    });
}

// --- Zmiana statusu jednostki ---
function changeUnitStatus(unitId, newStatus) {
    if (units[unitId]) {
        units[unitId].status = newStatus;
        updateUnit(units[unitId]);
    }
}

// --- Zmiana callsignu jednostki ---
function changeUnitCallsign(unitId, newCallsign) {
    if (units[unitId]) {
        units[unitId].name = newCallsign;
        updateUnit(units[unitId]);
        alert(`Callsign jednostki ${unitId} zmieniony na: ${newCallsign}`);
    } else {
        alert(`Jednostka o ID ${unitId} nie istnieje!`);
    }
}

// --- Przypisanie jednostki do zgłoszenia ---
async function assignUnitToReport(reportId) {
    const availableUnits = Object.values(units).filter(u => u.status === 'available');
    if (availableUnits.length === 0) {
        alert('Brak dostępnych jednostek do przypisania!');
        return;
    }
    
    const unitList = availableUnits.map(u => `${u.id} (${u.name})`).join('\n');
    const userInput = prompt('Podaj ID LUB callsign jednostki do przypisania:\nDostępne jednostki:\n' + unitList);
    
    if (!userInput) return;
    
    // Szukaj jednostki po ID lub callsign
    let unitToAssign = null;
    
    // Najpierw sprawdź po ID
    if (units[userInput]) {
        unitToAssign = units[userInput];
    } else {
        // Jeśli nie znaleziono po ID, szukaj po callsign
        unitToAssign = Object.values(units).find(u => u.name === userInput);
    }
    
    if (unitToAssign) {
        const reportIndex = reports.findIndex(r => r.id === reportId);
        if (reportIndex !== -1) {
            reports[reportIndex].assignedUnit = unitToAssign.id;
            
            // Aktualizuj zgłoszenie na serwerze
            try {
                const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reports[reportIndex])
                });
                
                const result = await response.json();
                if (result.status === 'ok') {
                    // Zmień status jednostki na "na interwencji"
                    changeUnitStatus(unitToAssign.id, 'on-intervention');
                    renderReports();
                }
            } catch (error) {
                console.error('Błąd przypisywania jednostki:', error);
            }
        }
    } else {
        alert(`Nie znaleziono jednostki o ID/callsign: ${userInput}`);
    }
}

// --- Zwolnienie jednostki ze zgłoszenia ---
async function releaseUnitFromReport(reportId) {
    const reportIndex = reports.findIndex(r => r.id === reportId);
    if (reportIndex !== -1 && reports[reportIndex].assignedUnit) {
        const unitId = reports[reportIndex].assignedUnit;
        reports[reportIndex].assignedUnit = null;
        
        // Aktualizuj zgłoszenie na serwerze
        try {
            const response = await fetch(`${SERVER_URL}/reports/${reportId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reports[reportIndex])
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                // Zmień status jednostki na "dostępny"
                changeUnitStatus(unitId, 'available');
                renderReports();
            }
        } catch (error) {
            console.error('Błąd zwalniania jednostki:', error);
        }
    }
}

// --- Obsługa przycisku tworzenia zgłoszenia ---
document.getElementById('createReport').addEventListener('click', () => {
    const tier = document.getElementById('tier').value;
    const description = document.getElementById('description').value;
    const contact = document.getElementById('contact').value;
    const status = document.getElementById('status').value;

    if (!selectedLatLng) return alert('Kliknij na mapie, aby ustawić lokalizację zgłoszenia!');
    if (!description) return alert('Podaj opis zgłoszenia!');

    // Generuj trzycyfrowe ID (001, 002, ..., 999)
    const nextId = reports.length > 0 
        ? Math.max(...reports.map(r => parseInt(r.id))) + 1 
        : 1;
    
    const reportId = nextId.toString().padStart(3, '0');
    
    const report = {
        id: reportId,
        tier, description, contact, status,
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        timestamp: Date.now(),
        assignedUnit: null
    };

    addReport(report);

    // Reset
    document.getElementById('description').value = '';
    document.getElementById('contact').value = '';
    selectedLatLng = null;
    document.getElementById('coordsDisplay').innerText = 'Nie wybrano lokalizacji';
});

// --- Obsługa zmiany callsignu ---
document.getElementById('changeCallsignBtn').addEventListener('click', () => {
    const unitId = document.getElementById('unitIdInput').value;
    const newCallsign = document.getElementById('newCallsignInput').value;
    
    if (!unitId) return alert('Podaj ID jednostki!');
    if (!newCallsign) return alert('Podaj nowy callsign!');
    
    changeUnitCallsign(unitId, newCallsign);
    
    // Reset formularza
    document.getElementById('unitIdInput').value = '';
    document.getElementById('newCallsignInput').value = '';
});

// --- Pobieranie pozycji z serwera ---
async function fetchPositions() {
    try {
        const response = await fetch(`${SERVER_URL}/positions`);
        const data = await response.json();
        
        // Aktualizuj jednostki na podstawie danych z serwera
        Object.entries(data).forEach(([id, unitData]) => {
            // Zachowaj istniejący status jeśli jednostka już istnieje
            const existingStatus = units[id]?.status || 'available';
            const existingName = units[id]?.name || id; // Zachowaj istniejący callsign
            
            if (!units[id] || units[id].lat !== unitData.lat || units[id].lng !== unitData.lng) {
                updateUnit({
                    id: id,
                    name: existingName,
                    lat: unitData.lat,
                    lng: unitData.lng,
                    status: existingStatus,
                    timestamp: unitData.timestamp
                });
            }
        });
    } catch (error) {
        console.error('Błąd pobierania pozycji:', error);
    }
}

// --- Pobieranie zgłoszeń z serwera ---
async function fetchReports() {
    try {
        const response = await fetch(`${SERVER_URL}/reports`);
        const data = await response.json();
        
        // Usuń stare znaczniki
        Object.values(markersReports).forEach(marker => map.removeLayer(marker));
        markersReports = {};
        
        // Aktualizuj listę zgłoszeń
        reports = data;
        
        // Dodaj nowe znaczniki
        reports.forEach(report => {
            const circle = L.circleMarker([report.lat, report.lng], reportCircleStyles[report.tier])
                .addTo(map)
                .bindPopup(`
                    <b>Zgłoszenie #${report.id}</b><br>
                    <b>Tier:</b> ${report.tier}<br>
                    <b>Opis:</b> ${report.description}<br>
                    <b>Kontakt:</b> ${report.contact}<br>
                    <b>Status:</b> ${report.status}
                    ${report.assignedUnit ? `<br><b>Przypisana jednostka:</b> ${report.assignedUnit}` : ''}
                    <br><button onclick="deleteReport('${report.id}')">Usuń zgłoszenie</button>
                `);
            
            markersReports[report.id] = circle;
        });
        
        renderReports();
    } catch (error) {
        console.error('Błąd pobierania zgłoszeń:', error);
    }
}

// --- Pobieranie jednostek z serwera ---
async function fetchUnits() {
    try {
        const response = await fetch(`${SERVER_URL}/units`);
        const data = await response.json();
        
        // Usuń stare znaczniki
        Object.values(markersUnits).forEach(marker => map.removeLayer(marker));
        markersUnits = {};
        
        // Aktualizuj listę jednostek
        units = data;
        
        // Dodaj nowe znaczniki
        Object.entries(units).forEach(([id, unitData]) => {
            const circle = L.circleMarker([unitData.lat, unitData.lng], unitCircleStyles[unitData.status] || unitCircleStyles.available)
                .addTo(map)
                .bindPopup(`
                    <b>${unitData.name} (${id})</b><br>
                    Status: ${unitData.status}<br>
                    Ostatnia aktualizacja: ${new Date(unitData.timestamp || Date.now()).toLocaleTimeString()}
                `);
            
            markersUnits[id] = circle;
        });
        
        renderUnits();
    } catch (error) {
        console.error('Błąd pobierania jednostek:', error);
    }
}

// Regularne pobieranie danych co 5 sekund
setInterval(() => {
    fetchPositions();
    fetchReports();
    fetchUnits();
}, 5000);

// Inicjalizacja przy starcie
setTimeout(() => {
    fetchPositions();
    fetchReports();
    fetchUnits();
}, 1000);
</script>
</body>
</html>
